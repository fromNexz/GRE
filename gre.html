<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento Empresarial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="shortcut icon" href="src/assets/images/tool.png" type="image/x-icon">
    <style>
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        .table-hover:hover {
            background-color: #f9fafb;
        }
        .status-emprestado, .status-saida {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-devolvido, .status-retorno {
            background-color: #d1fae5;
            color: #065f46;
        }
        .overdue {
            background-color: #fef2f2 !important;
        }
        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .btn-success {
            background-color: #16a34a;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-success:hover {
            background-color: #15803d;
        }
        .tab-active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .tab-inactive {
            background-color: white;
            color: #6b7280;
            border-color: #d1d5db;
        }
        .tab-inactive:hover {
            background-color: #f9fafb;
            color: #374151;
        }
        .combustivel-cheio { background-color: #dcfce7; color: #166534; }
        .combustivel-meio { background-color: #fef3c7; color: #92400e; }
        .combustivel-baixo { background-color: #fef2f2; color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-gray-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <svg class="h-8 w-8 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <h1 class="text-xl font-bold">Sistema de Gerenciamento Empresarial</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-300" id="contador">
                        Total: 0 | Ativos: 0
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Abas de Navegação -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
        <div class="bg-white rounded-t-lg border-b border-gray-200">
            <div class="flex space-x-1 p-1">
                <button id="tabEPI" class="flex items-center px-4 py-2 text-sm font-medium rounded-md tab-active transition-colors">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    Gerenciamento de EPI
                </button>
                <button id="tabVeiculos" class="flex items-center px-4 py-2 text-sm font-medium rounded-md tab-inactive transition-colors">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                    Entrada e Saída de Veículos
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Seção EPI -->
        <div id="sectionEPI" class="pb-8">
            <!-- Controles EPI -->
            <div class="bg-white rounded-b-lg shadow-sm border-l border-r border-b border-gray-200 p-6 mb-8">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <button id="btnNovoEmprestimo" class="inline-flex items-center px-4 py-2 btn-primary rounded-lg shadow-sm">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Novo Empréstimo
                        </button>
                        
                        <button id="btnExportarEPI" class="inline-flex items-center px-4 py-2 btn-success rounded-lg shadow-sm">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Exportar CSV
                        </button>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <svg class="h-4 w-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="searchInputEPI" placeholder="Buscar funcionário ou EPI..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <select id="filterStatusEPI" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="todos">Todos</option>
                            <option value="emprestado">Emprestados</option>
                            <option value="devolvido">Devolvidos</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Lista de Empréstimos EPI -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funcionário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EPI/Ferramenta</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Empréstimo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prev. Retorno</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaEmprestimos" class="bg-white divide-y divide-gray-200">
                            <!-- Conteúdo será inserido dinamicamente -->
                        </tbody>
                    </table>
                    
                    <div id="emptyStateEPI" class="text-center py-12 hidden">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhum empréstimo cadastrado</h3>
                        <p class="mt-1 text-sm text-gray-500">Comece adicionando um novo empréstimo de EPI</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção Veículos -->
        <div id="sectionVeiculos" class="pb-8 hidden">
            <!-- Controles Veículos -->
            <div class="bg-white rounded-b-lg shadow-sm border-l border-r border-b border-gray-200 p-6 mb-8">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap items-center gap-4">
                        <button id="btnNovaSaida" class="inline-flex items-center px-4 py-2 btn-primary rounded-lg shadow-sm">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Nova Saída
                        </button>
                        
                        <button id="btnExportarVeiculos" class="inline-flex items-center px-4 py-2 btn-success rounded-lg shadow-sm">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Exportar CSV
                        </button>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <svg class="h-4 w-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="searchInputVeiculos" placeholder="Buscar funcionário ou veículo..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <select id="filterStatusVeiculos" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="todos">Todos</option>
                            <option value="saida">Em Uso</option>
                            <option value="retorno">Devolvidos</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Lista de Saídas de Veículos -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Funcionário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Veículo</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora Saída</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prev. Retorno</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KM/Combustível</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaVeiculos" class="bg-white divide-y divide-gray-200">
                            <!-- Conteúdo será inserido dinamicamente -->
                        </tbody>
                    </table>
                    
                    <div id="emptyStateVeiculos" class="text-center py-12 hidden">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Nenhuma saída de veículo cadastrada</h3>
                        <p class="mt-1 text-sm text-gray-500">Comece registrando uma nova saída de veículo</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal EPI -->
    <div id="modalEPI" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 space-y-6">
                <div class="flex items-center justify-between border-b pb-4">
                    <h2 id="modalTitleEPI" class="text-xl font-semibold text-gray-900">Novo Empréstimo</h2>
                    <button id="btnFecharModalEPI" class="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none">×</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Funcionário *</label>
                        <input type="text" id="funcionario" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nome do funcionário">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">EPI/Ferramenta *</label>
                        <input type="text" id="epi" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nome do EPI ou ferramenta">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data do Empréstimo *</label>
                            <input type="date" id="dataEmprestimo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Previsão de Retorno *</label>
                            <input type="date" id="dataPrevistaRetorno" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="emprestado">Emprestado</option>
                            <option value="devolvido">Devolvido</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                        <textarea id="observacoes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Observações adicionais..."></textarea>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="btnCancelarEPI" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
                    <button id="btnSalvarEPI" class="px-4 py-2 btn-primary rounded-lg">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Veículos -->
    <div id="modalVeiculos" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 space-y-6">
                <div class="flex items-center justify-between border-b pb-4">
                    <h2 id="modalTitleVeiculos" class="text-xl font-semibold text-gray-900">Nova Saída de Veículo</h2>
                    <button id="btnFecharModalVeiculos" class="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none">×</button>
                </div>

                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Funcionário *</label>
                            <input type="text" id="funcionarioVeiculo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nome do funcionário">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Veículo *</label>
                            <input type="text" id="veiculo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: Polo Branco">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Placa *</label>
                        <input type="text" id="placa" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: ABC-1234">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data de Saída *</label>
                            <input type="date" id="dataSaida" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Horário de Saída *</label>
                            <input type="time" id="horarioSaida" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Prev. Retorno</label>
                            <input type="date" id="dataPrevistaRetornoVeiculo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Horário Prev. Retorno</label>
                            <input type="time" id="horarioPrevistaRetorno" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">KM de Saída *</label>
                            <input type="number" id="kmSaida" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: 12261">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Combustível na Saída *</label>
                            <select id="combustivelSaida" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Selecione...</option>
                                <option value="cheio">Cheio</option>
                                <option value="meio">Meio Tanque</option>
                                <option value="baixo">Menos da Metade</option>
                            </select>
                        </div>
                    </div>

                    <div id="retornoSection" class="space-y-4 pt-4 border-t border-gray-200 hidden">
                        <h3 class="text-lg font-medium text-gray-900">Dados do Retorno</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Data de Retorno</label>
                                <input type="date" id="dataRetornoVeiculo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Horário de Retorno</label>
                                <input type="time" id="horarioRetorno" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">KM de Retorno</label>
                                <input type="number" id="kmRetorno" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ex: 12274">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Combustível no Retorno</label>
                                <select id="combustivelRetorno" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Selecione...</option>
                                    <option value="cheio">Cheio</option>
                                    <option value="meio">Meio Tanque</option>
                                    <option value="baixo">Menos da Metade</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Valor Abastecido Durante o Uso</label>
                            <input type="number" step="0.01" id="valorAbastecido" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="R$ 0,00">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="statusVeiculo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="saida">Em Uso</option>
                            <option value="retorno">Devolvido</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                        <textarea id="observacoesVeiculo" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Motivo da saída, destino, etc..."></textarea>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button id="btnCancelarVeiculos" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
                    <button id="btnSalvarVeiculos" class="px-4 py-2 btn-primary rounded-lg">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let emprestimos = [];
        let veiculos = [];
        let editingIdEPI = null;
        let editingIdVeiculos = null;
        let currentTab = 'EPI';

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Iniciando sistema...');
            carregarDados();
            configurarEventos();
            renderizarTabelas();
            atualizarContador();
            console.log('Sistema iniciado com sucesso');
        });

        // Verificar se localStorage está disponível
        function verificarLocalStorage() {
            try {
                const teste = '__teste__';
                localStorage.setItem(teste, teste);
                localStorage.removeItem(teste);
                return true;
            } catch (e) {
                console.error('localStorage não está disponível:', e);
                return false;
            }
        }

        // Configurar eventos
        function configurarEventos() {
            // Verificar se localStorage está disponível
            if (!verificarLocalStorage()) {
                alert('Aviso: O armazenamento local não está disponível. Os dados podem não ser salvos corretamente.');
            }

            // Eventos das abas
            document.getElementById('tabEPI').addEventListener('click', () => mudarAba('EPI'));
            document.getElementById('tabVeiculos').addEventListener('click', () => mudarAba('Veiculos'));

            // Eventos EPI
            document.getElementById('btnNovoEmprestimo').addEventListener('click', abrirModalEPI);
            document.getElementById('btnExportarEPI').addEventListener('click', exportarCSVEPI);
            document.getElementById('btnFecharModalEPI').addEventListener('click', fecharModalEPI);
            document.getElementById('btnCancelarEPI').addEventListener('click', fecharModalEPI);
            document.getElementById('btnSalvarEPI').addEventListener('click', salvarEmprestimo);
            document.getElementById('searchInputEPI').addEventListener('input', renderizarTabelaEPI);
            document.getElementById('filterStatusEPI').addEventListener('change', renderizarTabelaEPI);

            // Eventos Veículos
            document.getElementById('btnNovaSaida').addEventListener('click', abrirModalVeiculos);
            document.getElementById('btnExportarVeiculos').addEventListener('click', exportarCSVVeiculos);
            document.getElementById('btnFecharModalVeiculos').addEventListener('click', fecharModalVeiculos);
            document.getElementById('btnCancelarVeiculos').addEventListener('click', fecharModalVeiculos);
            document.getElementById('btnSalvarVeiculos').addEventListener('click', salvarVeiculo);
            document.getElementById('searchInputVeiculos').addEventListener('input', renderizarTabelaVeiculos);
            document.getElementById('filterStatusVeiculos').addEventListener('change', renderizarTabelaVeiculos);
            document.getElementById('statusVeiculo').addEventListener('change', toggleRetornoSection);

            // Definir datas/horas atuais como padrão
            const hoje = new Date().toISOString().split('T')[0];
            const agora = new Date().toTimeString().slice(0, 5);
            document.getElementById('dataEmprestimo').value = hoje;
            document.getElementById('dataSaida').value = hoje;
            document.getElementById('horarioSaida').value = agora;
        }

        // Carregar dados do localStorage
        function carregarDados() {
            try {
                const dadosEPI = localStorage.getItem('sistema-epi-emprestimos');
                const dadosVeiculos = localStorage.getItem('sistema-veiculos-saidas');
                
                if (dadosEPI) {
                    emprestimos = JSON.parse(dadosEPI);
                    console.log('Dados EPI carregados:', emprestimos.length, 'registros');
                }
                if (dadosVeiculos) {
                    veiculos = JSON.parse(dadosVeiculos);
                    console.log('Dados Veículos carregados:', veiculos.length, 'registros');
                }
            } catch (error) {
                console.error('Erro ao carregar dados do localStorage:', error);
                emprestimos = [];
                veiculos = [];
            }
        }

        // Salvar dados no localStorage
        function salvarDados() {
            try {
                localStorage.setItem('sistema-epi-emprestimos', JSON.stringify(emprestimos));
                localStorage.setItem('sistema-veiculos-saidas', JSON.stringify(veiculos));
                console.log('Dados salvos no localStorage - EPI:', emprestimos.length, 'Veículos:', veiculos.length);
            } catch (error) {
                console.error('Erro ao salvar dados no localStorage:', error);
                alert('Erro ao salvar dados. Verifique se há espaço disponível no navegador.');
            }
        }

        // Mudar aba
        function mudarAba(aba) {
            currentTab = aba;
            
            // Atualizar aparência das abas
            if (aba === 'EPI') {
                document.getElementById('tabEPI').className = 'flex items-center px-4 py-2 text-sm font-medium rounded-md tab-active transition-colors';
                document.getElementById('tabVeiculos').className = 'flex items-center px-4 py-2 text-sm font-medium rounded-md tab-inactive transition-colors';
                document.getElementById('sectionEPI').classList.remove('hidden');
                document.getElementById('sectionVeiculos').classList.add('hidden');
            } else {
                document.getElementById('tabEPI').className = 'flex items-center px-4 py-2 text-sm font-medium rounded-md tab-inactive transition-colors';
                document.getElementById('tabVeiculos').className = 'flex items-center px-4 py-2 text-sm font-medium rounded-md tab-active transition-colors';
                document.getElementById('sectionEPI').classList.add('hidden');
                document.getElementById('sectionVeiculos').classList.remove('hidden');
            }
            
            atualizarContador();
        }

        // Toggle seção de retorno no modal de veículos
        function toggleRetornoSection() {
            const status = document.getElementById('statusVeiculo').value;
            const retornoSection = document.getElementById('retornoSection');
            
            if (status === 'retorno') {
                retornoSection.classList.remove('hidden');
            } else {
                retornoSection.classList.add('hidden');
            }
        }

        // === FUNÇÕES EPI ===

        // Abrir modal EPI
        function abrirModalEPI(emprestimo = null) {
            const modal = document.getElementById('modalEPI');
            const title = document.getElementById('modalTitleEPI');
            
            if (emprestimo) {
                title.textContent = 'Editar Empréstimo';
                editingIdEPI = emprestimo.id;
                document.getElementById('funcionario').value = emprestimo.funcionario;
                document.getElementById('epi').value = emprestimo.epi;
                document.getElementById('dataEmprestimo').value = emprestimo.dataEmprestimo;
                document.getElementById('dataPrevistaRetorno').value = emprestimo.dataPrevistaRetorno;
                document.getElementById('status').value = emprestimo.status;
                document.getElementById('observacoes').value = emprestimo.observacoes || '';
            } else {
                title.textContent = 'Novo Empréstimo';
                editingIdEPI = null;
                limparFormularioEPI();
            }
            
            modal.classList.remove('hidden');
        }

        // Fechar modal EPI
        function fecharModalEPI() {
            document.getElementById('modalEPI').classList.add('hidden');
            editingIdEPI = null;
            limparFormularioEPI();
        }

        // Limpar formulário EPI
        function limparFormularioEPI() {
            document.getElementById('funcionario').value = '';
            document.getElementById('epi').value = '';
            document.getElementById('dataEmprestimo').value = new Date().toISOString().split('T')[0];
            document.getElementById('dataPrevistaRetorno').value = '';
            document.getElementById('status').value = 'emprestado';
            document.getElementById('observacoes').value = '';
        }

        // Salvar empréstimo
        function salvarEmprestimo() {
            const funcionario = document.getElementById('funcionario').value.trim();
            const epi = document.getElementById('epi').value.trim();
            const dataEmprestimo = document.getElementById('dataEmprestimo').value;
            const dataPrevistaRetorno = document.getElementById('dataPrevistaRetorno').value;
            const status = document.getElementById('status').value;
            const observacoes = document.getElementById('observacoes').value.trim();

            if (!funcionario || !epi || !dataEmprestimo || !dataPrevistaRetorno) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            const emprestimo = {
                funcionario,
                epi,
                dataEmprestimo,
                dataPrevistaRetorno,
                status,
                observacoes,
                dataAtualizacao: new Date().toISOString()
            };

            if (editingIdEPI) {
                const index = emprestimos.findIndex(e => e.id === editingIdEPI);
                if (index !== -1) {
                    emprestimos[index] = { ...emprestimo, id: editingIdEPI };
                    console.log('Empréstimo editado:', emprestimo);
                }
            } else {
                emprestimo.id = Date.now() + Math.random(); // Garante ID único
                emprestimo.dataCriacao = new Date().toISOString();
                emprestimos.push(emprestimo);
                console.log('Novo empréstimo criado:', emprestimo);
            }

            salvarDados();
            renderizarTabelaEPI();
            atualizarContador();
            fecharModalEPI();
        }

        // === FUNÇÕES VEÍCULOS ===

        // Abrir modal Veículos
        function abrirModalVeiculos(veiculo = null) {
            const modal = document.getElementById('modalVeiculos');
            const title = document.getElementById('modalTitleVeiculos');
            
            if (veiculo) {
                title.textContent = 'Editar Saída de Veículo';
                editingIdVeiculos = veiculo.id;
                document.getElementById('funcionarioVeiculo').value = veiculo.funcionario;
                document.getElementById('veiculo').value = veiculo.veiculo;
                document.getElementById('placa').value = veiculo.placa;
                document.getElementById('dataSaida').value = veiculo.dataSaida;
                document.getElementById('horarioSaida').value = veiculo.horarioSaida;
                document.getElementById('dataPrevistaRetornoVeiculo').value = veiculo.dataPrevistaRetorno || '';
                document.getElementById('horarioPrevistaRetorno').value = veiculo.horarioPrevistaRetorno || '';
                document.getElementById('kmSaida').value = veiculo.kmSaida;
                document.getElementById('combustivelSaida').value = veiculo.combustivelSaida;
                document.getElementById('statusVeiculo').value = veiculo.status;
                document.getElementById('observacoesVeiculo').value = veiculo.observacoes || '';
                
                // Campos de retorno
                document.getElementById('dataRetornoVeiculo').value = veiculo.dataRetorno || '';
                document.getElementById('horarioRetorno').value = veiculo.horarioRetorno || '';
                document.getElementById('kmRetorno').value = veiculo.kmRetorno || '';
                document.getElementById('combustivelRetorno').value = veiculo.combustivelRetorno || '';
                document.getElementById('valorAbastecido').value = veiculo.valorAbastecido || '';
                
                toggleRetornoSection();
            } else {
                title.textContent = 'Nova Saída de Veículo';
                editingIdVeiculos = null;
                limparFormularioVeiculos();
            }
            
            modal.classList.remove('hidden');
        }

        // Fechar modal Veículos
        function fecharModalVeiculos() {
            document.getElementById('modalVeiculos').classList.add('hidden');
            editingIdVeiculos = null;
            limparFormularioVeiculos();
        }

        // Limpar formulário Veículos
        function limparFormularioVeiculos() {
            document.getElementById('funcionarioVeiculo').value = '';
            document.getElementById('veiculo').value = '';
            document.getElementById('placa').value = '';
            document.getElementById('dataSaida').value = new Date().toISOString().split('T')[0];
            document.getElementById('horarioSaida').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('dataPrevistaRetornoVeiculo').value = '';
            document.getElementById('horarioPrevistaRetorno').value = '';
            document.getElementById('kmSaida').value = '';
            document.getElementById('combustivelSaida').value = '';
            document.getElementById('statusVeiculo').value = 'saida';
            document.getElementById('observacoesVeiculo').value = '';
            
            // Limpar campos de retorno
            document.getElementById('dataRetornoVeiculo').value = '';
            document.getElementById('horarioRetorno').value = '';
            document.getElementById('kmRetorno').value = '';
            document.getElementById('combustivelRetorno').value = '';
            document.getElementById('valorAbastecido').value = '';
            
            toggleRetornoSection();
        }

        // Salvar veículo
        function salvarVeiculo() {
            const funcionario = document.getElementById('funcionarioVeiculo').value.trim();
            const veiculoNome = document.getElementById('veiculo').value.trim();
            const placa = document.getElementById('placa').value.trim();
            const dataSaida = document.getElementById('dataSaida').value;
            const horarioSaida = document.getElementById('horarioSaida').value;
            const kmSaida = document.getElementById('kmSaida').value;
            const combustivelSaida = document.getElementById('combustivelSaida').value;
            const status = document.getElementById('statusVeiculo').value;

            if (!funcionario || !veiculoNome || !placa || !dataSaida || !horarioSaida || !kmSaida || !combustivelSaida) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            const veiculo = {
                funcionario,
                veiculo: veiculoNome,
                placa: placa.toUpperCase(),
                dataSaida,
                horarioSaida,
                dataPrevistaRetorno: document.getElementById('dataPrevistaRetornoVeiculo').value,
                horarioPrevistaRetorno: document.getElementById('horarioPrevistaRetorno').value,
                kmSaida: parseInt(kmSaida),
                combustivelSaida,
                status,
                observacoes: document.getElementById('observacoesVeiculo').value.trim(),
                dataAtualizacao: new Date().toISOString()
            };

            // Campos de retorno (se o status for 'retorno')
            if (status === 'retorno') {
                veiculo.dataRetorno = document.getElementById('dataRetornoVeiculo').value;
                veiculo.horarioRetorno = document.getElementById('horarioRetorno').value;
                veiculo.kmRetorno = document.getElementById('kmRetorno').value ? parseInt(document.getElementById('kmRetorno').value) : null;
                veiculo.combustivelRetorno = document.getElementById('combustivelRetorno').value;
                veiculo.valorAbastecido = document.getElementById('valorAbastecido').value ? parseFloat(document.getElementById('valorAbastecido').value) : null;
            }

            if (editingIdVeiculos) {
                const index = veiculos.findIndex(v => v.id === editingIdVeiculos);
                if (index !== -1) {
                    veiculos[index] = { ...veiculo, id: editingIdVeiculos };
                    console.log('Veículo editado:', veiculo);
                }
            } else {
                veiculo.id = Date.now() + Math.random(); // Garante ID único
                veiculo.dataCriacao = new Date().toISOString();
                veiculos.push(veiculo);
                console.log('Nova saída de veículo criada:', veiculo);
            }

            salvarDados();
            renderizarTabelaVeiculos();
            atualizarContador();
            fecharModalVeiculos();
        }

        // === RENDERIZAÇÃO DAS TABELAS ===

        // Renderizar tabelas
        function renderizarTabelas() {
            renderizarTabelaEPI();
            renderizarTabelaVeiculos();
        }

        // Renderizar tabela EPI
        function renderizarTabelaEPI() {
            const tabela = document.getElementById('tabelaEmprestimos');
            const emptyState = document.getElementById('emptyStateEPI');
            const searchTerm = document.getElementById('searchInputEPI').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatusEPI').value;

            const emprestimosFiltrados = emprestimos.filter(emprestimo => {
                const matchesSearch = emprestimo.funcionario.toLowerCase().includes(searchTerm) ||
                                    emprestimo.epi.toLowerCase().includes(searchTerm);
                const matchesFilter = filterStatus === 'todos' || emprestimo.status === filterStatus;
                return matchesSearch && matchesFilter;
            });

            if (emprestimosFiltrados.length === 0) {
                tabela.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            tabela.innerHTML = emprestimosFiltrados.map(emprestimo => {
                const isOverdue = emprestimo.status === 'emprestado' && new Date(emprestimo.dataPrevistaRetorno) < new Date();
                const rowClass = isOverdue ? 'overdue' : '';
                
                return `
                    <tr class="table-hover ${rowClass}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <svg class="h-4 w-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <span class="text-sm font-medium text-gray-900">${emprestimo.funcionario}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-900">${emprestimo.epi}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-900">${formatarData(emprestimo.dataEmprestimo)}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm ${isOverdue ? 'text-red-600 font-medium' : 'text-gray-900'}">${formatarData(emprestimo.dataPrevistaRetorno)}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="toggleStatusEPI(${emprestimo.id})" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${emprestimo.status === 'emprestado' ? 'status-emprestado hover:bg-yellow-200' : 'status-devolvido hover:bg-green-200'} transition-colors">
                                ${emprestimo.status === 'emprestado' ? 'Emprestado' : 'Devolvido'}
                            </button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex items-center justify-end space-x-2">
                                <button onclick="editarEmprestimo(${emprestimo.id})" class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50" title="Editar">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="excluirEmprestimo(${emprestimo.id})" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50" title="Excluir">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Renderizar tabela Veículos
        function renderizarTabelaVeiculos() {
            const tabela = document.getElementById('tabelaVeiculos');
            const emptyState = document.getElementById('emptyStateVeiculos');
            const searchTerm = document.getElementById('searchInputVeiculos').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatusVeiculos').value;

            const veiculosFiltrados = veiculos.filter(veiculo => {
                const matchesSearch = veiculo.funcionario.toLowerCase().includes(searchTerm) ||
                                    veiculo.veiculo.toLowerCase().includes(searchTerm) ||
                                    veiculo.placa.toLowerCase().includes(searchTerm);
                const matchesFilter = filterStatus === 'todos' || veiculo.status === filterStatus;
                return matchesSearch && matchesFilter;
            });

            if (veiculosFiltrados.length === 0) {
                tabela.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            tabela.innerHTML = veiculosFiltrados.map(veiculo => {
                const isOverdue = veiculo.status === 'saida' && veiculo.dataPrevistaRetorno && 
                                new Date(veiculo.dataPrevistaRetorno) < new Date();
                const rowClass = isOverdue ? 'overdue' : '';
                
                const kmInfo = veiculo.kmRetorno ? 
                    `${veiculo.kmSaida}→${veiculo.kmRetorno} (${veiculo.kmRetorno - veiculo.kmSaida}km)` : 
                    `${veiculo.kmSaida}km`;

                const combustivelClass = getCombustivelClass(veiculo.combustivelSaida);
                const combustivelRetornoClass = veiculo.combustivelRetorno ? getCombustivelClass(veiculo.combustivelRetorno) : '';
                
                return `
                    <tr class="table-hover ${rowClass}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <svg class="h-4 w-4 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <span class="text-sm font-medium text-gray-900">${veiculo.funcionario}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 font-medium">${veiculo.veiculo}</div>
                            <div class="text-xs text-gray-500">${veiculo.placa}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${formatarData(veiculo.dataSaida)}</div>
                            <div class="text-xs text-gray-500">${veiculo.horarioSaida}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm ${isOverdue ? 'text-red-600 font-medium' : 'text-gray-900'}">${veiculo.dataPrevistaRetorno ? formatarData(veiculo.dataPrevistaRetorno) : '-'}</div>
                            <div class="text-xs ${isOverdue ? 'text-red-500' : 'text-gray-500'}">${veiculo.horarioPrevistaRetorno || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${kmInfo}</div>
                            <div class="flex items-center space-x-1 mt-1">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${combustivelClass}">
                                    ${getCombustivelText(veiculo.combustivelSaida)}
                                </span>
                                ${veiculo.combustivelRetorno ? `<span class="text-xs text-gray-400">→</span><span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${combustivelRetornoClass}">${getCombustivelText(veiculo.combustivelRetorno)}</span>` : ''}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="toggleStatusVeiculo(${veiculo.id})" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${veiculo.status === 'saida' ? 'status-saida hover:bg-yellow-200' : 'status-retorno hover:bg-green-200'} transition-colors">
                                ${veiculo.status === 'saida' ? 'Em Uso' : 'Devolvido'}
                            </button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex items-center justify-end space-x-2">
                                <button onclick="editarVeiculo(${veiculo.id})" class="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50" title="Editar">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="excluirVeiculo(${veiculo.id})" class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50" title="Excluir">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // === FUNÇÕES AUXILIARES ===

        // Atualizar contador
        function atualizarContador() {
            if (currentTab === 'EPI') {
                const total = emprestimos.length;
                const emprestados = emprestimos.filter(e => e.status === 'emprestado').length;
                document.getElementById('contador').textContent = `Total: ${total} | Emprestados: ${emprestados}`;
            } else {
                const total = veiculos.length;
                const emUso = veiculos.filter(v => v.status === 'saida').length;
                document.getElementById('contador').textContent = `Total: ${total} | Em Uso: ${emUso}`;
            }
        }

        // Obter classe CSS do combustível
        function getCombustivelClass(combustivel) {
            switch(combustivel) {
                case 'cheio': return 'combustivel-cheio';
                case 'meio': return 'combustivel-meio';
                case 'baixo': return 'combustivel-baixo';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Obter texto do combustível
        function getCombustivelText(combustivel) {
            switch(combustivel) {
                case 'cheio': return 'Cheio';
                case 'meio': return 'Meio';
                case 'baixo': return 'Baixo';
                default: return '-';
            }
        }

        // === AÇÕES DOS REGISTROS ===

        // Alternar status EPI
        function toggleStatusEPI(id) {
            const emprestimo = emprestimos.find(e => e.id === id);
            if (emprestimo) {
                emprestimo.status = emprestimo.status === 'emprestado' ? 'devolvido' : 'emprestado';
                emprestimo.dataRetorno = emprestimo.status === 'devolvido' ? new Date().toISOString().split('T')[0] : null;
                emprestimo.dataAtualizacao = new Date().toISOString();
                salvarDados();
                renderizarTabelaEPI();
                atualizarContador();
            }
        }

        // Alternar status Veículo
        function toggleStatusVeiculo(id) {
            const veiculo = veiculos.find(v => v.id === id);
            if (veiculo) {
                if (veiculo.status === 'saida') {
                    // Marcar como devolvido com dados básicos
                    veiculo.status = 'retorno';
                    veiculo.dataRetorno = new Date().toISOString().split('T')[0];
                    veiculo.horarioRetorno = new Date().toTimeString().slice(0, 5);
                } else {
                    veiculo.status = 'saida';
                    veiculo.dataRetorno = null;
                    veiculo.horarioRetorno = null;
                }
                veiculo.dataAtualizacao = new Date().toISOString();
                salvarDados();
                renderizarTabelaVeiculos();
                atualizarContador();
            }
        }

        // Editar empréstimo
        function editarEmprestimo(id) {
            const emprestimo = emprestimos.find(e => e.id === id);
            if (emprestimo) {
                abrirModalEPI(emprestimo);
            }
        }

        // Editar veículo
        function editarVeiculo(id) {
            const veiculo = veiculos.find(v => v.id === id);
            if (veiculo) {
                abrirModalVeiculos(veiculo);
            }
        }

        // Excluir empréstimo
        function excluirEmprestimo(id) {
            if (confirm('Tem certeza que deseja excluir este registro de empréstimo?')) {
                emprestimos = emprestimos.filter(e => e.id !== id);
                salvarDados();
                renderizarTabelaEPI();
                atualizarContador();
            }
        }

        // Excluir veículo
        function excluirVeiculo(id) {
            if (confirm('Tem certeza que deseja excluir este registro de veículo?')) {
                veiculos = veiculos.filter(v => v.id !== id);
                salvarDados();
                renderizarTabelaVeiculos();
                atualizarContador();
            }
        }

        // === EXPORTAÇÃO CSV ===

        // Exportar CSV EPI
        function exportarCSVEPI() {
            if (emprestimos.length === 0) {
                alert('Não há dados de empréstimos para exportar.');
                return;
            }

            const headers = ['Funcionário', 'EPI/Ferramenta', 'Data do Empréstimo', 'Data Prevista Retorno', 'Data Retorno Real', 'Status', 'Observações', 'Data de Registro'];
            
            const dados = emprestimos.map(item => [
                item.funcionario,
                item.epi,
                formatarData(item.dataEmprestimo),
                formatarData(item.dataPrevistaRetorno),
                item.dataRetorno ? formatarData(item.dataRetorno) : '-',
                item.status === 'emprestado' ? 'Emprestado' : 'Devolvido',
                item.observacoes || '-',
                formatarDataHora(item.dataCriacao)
            ]);

            baixarCSV(headers, dados, 'emprestimos-epi');
        }

        // Exportar CSV Veículos
        function exportarCSVVeiculos() {
            if (veiculos.length === 0) {
                alert('Não há dados de veículos para exportar.');
                return;
            }

            const headers = [
                'Funcionário', 'Veículo', 'Placa', 'Data Saída', 'Horário Saída', 
                'Data Prev. Retorno', 'Horário Prev. Retorno', 'Data Retorno', 'Horário Retorno',
                'KM Saída', 'KM Retorno', 'KM Percorridos', 'Combustível Saída', 'Combustível Retorno',
                'Valor Abastecido', 'Status', 'Observações', 'Data de Registro'
            ];
            
            const dados = veiculos.map(item => [
                item.funcionario,
                item.veiculo,
                item.placa,
                formatarData(item.dataSaida),
                item.horarioSaida,
                item.dataPrevistaRetorno ? formatarData(item.dataPrevistaRetorno) : '-',
                item.horarioPrevistaRetorno || '-',
                item.dataRetorno ? formatarData(item.dataRetorno) : '-',
                item.horarioRetorno || '-',
                item.kmSaida,
                item.kmRetorno || '-',
                item.kmRetorno ? (item.kmRetorno - item.kmSaida) : '-',
                getCombustivelText(item.combustivelSaida),
                item.combustivelRetorno ? getCombustivelText(item.combustivelRetorno) : '-',
                item.valorAbastecido ? `R$ ${item.valorAbastecido.toFixed(2)}` : '-',
                item.status === 'saida' ? 'Em Uso' : 'Devolvido',
                item.observacoes || '-',
                formatarDataHora(item.dataCriacao)
            ]);

            baixarCSV(headers, dados, 'saidas-veiculos');
        }

        // Função auxiliar para baixar CSV
        function baixarCSV(headers, dados, nomeArquivo) {
            const csvContent = [headers, ...dados]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${nomeArquivo}-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // === FORMATAÇÃO ===

        // Formattar data
        function formatarData(dateString) {
            if (!dateString) return '-';
            return new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        // Formattar data e hora
        function formatarDataHora(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
        }
    </script>
</body>
</html>